<!DOCTYPE html>
<html>
<head>

		<meta charset="utf-8" />
        <meta name="format-detection" content="telephone=no" />
        <meta name="msapplication-tap-highlight" content="no" />
        <!-- WARNING: for iOS 7, remove the width=device-width and height=device-height attributes. See https://issues.apache.org/jira/browse/CB-4323 -->
        <meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width, height=device-height, target-densitydpi=device-dpi" />
        
        <link rel="stylesheet" type="text/css" href="css/index.css" /><!--phonegap-->
        <link rel="stylesheet" href="js/jQueryMobile/jquery.mobile-1.4.5.min.css"><!--jquerymobile-->
		<script src="js/jquery-1.11.2.min.js"></script>
		<script src="js/jQueryMobile/jquery.mobile-1.4.5.min.js"></script>

		<link rel="stylesheet" type="text/css" href="mystyle.css"><!--my-->

		<!--Inicializar plugin de phonegap-->
		<script type="text/javascript" src="cordova.js"></script>
        <script type="text/javascript" src="js/index.js"></script>
        <script type="text/javascript">
					
					app.initialize();
</script>
<script>

					//PARAR CAPTURAR FOTO
					function capturephoto () {
						  	sessionStorage.removeItem('imagepath');
            				navigator.camera.getPicture(onPhotoDataSuccess, onFail, {quality: 50,
                			destinationType: Camera.DestinationType.FILE_URI});            
        			}

			       function onPhotoDataSuccess(imageURI) { 
		        			// Uncomment to view the base64 encoded image data
		        			// console.log(imageData);

		        			// Get image handle
		        	       // var imgProfile = document.getElementById('imgProfile');

//						  	alert ("onPhotoDataSuccess");
		        			// Show the captured photo
					        // The inline CSS rules are used to resize the image
					        //
					      //  imgProfile.src = imageURI;

					        if(sessionStorage.isprofileimage==1){
					            getLocation();
					        }
//					        alert("URI" + imageURI)
					        movePic(imageURI);
					}

					// Called if something bad happens.
					
					function onFail(message) {
					    alert('Failed because: ' + message);
					}
					
					//mover la imagen temporal obtenida, a la tarjeta SD
					function movePic(file){ 
					    window.resolveLocalFileSystemURI(file, resolveOnSuccess, resOnError); 
					} 

					//Callback function when the file system uri has been resolved
					function resolveOnSuccess(entry){ 
					    var d = new Date();
					    var n = d.getTime();
					    //new file name
					    var newFileName = n + ".jpg";
					    var myFolderApp = "MyAppFolder";
			    
						window.requestFileSystem(LocalFileSystem.PERSISTENT, 0, function(fileSys) { 
						 //The folder is created if doesn't exist
						 fileSys.root.getDirectory( myFolderApp,
										 {create:true, exclusive: false},
										 function(directory) {
											 entry.moveTo(directory, newFileName, successMove, resOnError);
										 },
										 resOnError);
										 },
						 resOnError);
						 }
					}

					//Callback function when the file has been moved successfully - inserting the complete path
					function successMove(entry) {
					    //Store imagepath in session for future use
					    // like to store it in database
						// copiar la imagen a la sd

					    sessionStorage.setItem('imagepath', entry.fullPath);
					   // alert (entry.fullPath);
						path_actual=entry.fullPath;
					}

					function resOnError(error) {
					    alert(error.code);
					}

				
		</script>
		
		<script>
		var cantidad_total = "0";
		var cantidad_actual = "0";
		var path_actual = ""; // para guardar la dirección de la foto en la tarjeta SD
		var lista_tickets=[];// array de tickets, donde un ticket será una cantidad y un string de la ruta de una foto
		

		</script>

</head>

<body>


<!--PAGINA 1: INICIO-->
<div data-role="page" id="pageone">
		<div id="marco" data-role="header">
		    <h1>Gastos</h1>
		</div>

   		<div data-role="main" class="ui-content">
				<p id="Mostrar_Cantidad">Gastos: 0 €</p>
				<p id="Numero_tickets">Tickets: 0</p>
				<a href="#pagetwo" data-role="button" data-inline="true" data-theme="b" data-transition="fade">Inserta cantidad</a>
				</br>
				<button id="newAccount" data-inline="true" data-theme="b" onclick="nuevosgastos()">Reiniciar</button>
		</div>

		<div class="marco" data-role="footer">
			<p>MyApp</p>
		</div>




</div> 

<!--PAGINA 2: -->
<div data-role="page" id="pagetwo">
		<div class="marco" data-role="header">
    		<h1>Calculador</h1>
  		</div>

   		<div data-role="main" class="ui-content">
					
					<div id="Total_Amount_label">Total acumulado: 0 &#8364;</div>
					<div id="Amount_label">Total ahora: 0 &#8364;</div>

					<p>Introduce cantidad:</p>
					<div class="container">
						<div class="fila_tabla">
							<div class="item"><button id="bt7" onclick="seleccionar('7')">7</button></div>
							<div class="item"><button id="bt8" onclick="seleccionar('8')">8</button></div>
							<div class="item"><button id="bt9" onclick="seleccionar('9')">9</button></div>
						</div>
						<div class="fila_tabla">
							<div class="item"><button id="bt4" onclick="seleccionar('4')">4</button></div>
							<div class="item"><button id="bt5" onclick="seleccionar('5')">5</button></div>
							<div class="item"><button id="bt6" onclick="seleccionar('6')">6</button></div>
						</div>
						<div class="fila_tabla">
							<div class="item"><button id="bt1" onclick="seleccionar('1')">1</button></div>
							<div class="item"><button id="bt2" onclick="seleccionar('2')">2</button></div>
							<div class="item"><button id="bt3" onclick="seleccionar('3')">3</button></div>
						</div>
						<div class="fila_tabla">
							<div class="item"><button id="bt0" onclick="seleccionar('0')">0</button></div>
							<div class="item"><button id="btcoma" onclick="seleccionar('.')">,</button></div>
							<div class="item"><button id="btneg" onclick="seleccionar('-')">-</button></div>
						</div>
					</div>
					
					<button id="btdel" data-inline="true"onclick="suprimir()">Supr.</button>
					<button id="reset" data-inline="true" onclick="reset()">C</button></br>
					<button id="add" data-inline="true" data-theme="b" onclick="add()">Añadir</button>

					<button id="takephoto" data-inline="true" data-theme="b" onclick="capturephoto()">Foto ticket</button>
					<a href="#pageone" data-role="button" data-theme="b"  data-inline="true">Atrás</a>
		</div>

 		<div class="marco" data-role="footer">
		    <h1>DW31 app</h1>
		</div>
</div> 

		<script>

			function seleccionar(num) {
			
				if (num == '.')
				{
				// buscar un punto en el string de la cantidad actual
					var n = cantidad_actual.indexOf('.'); 
					
					// si no hay ningun punto (n==-1) entonces puedo poner '.' de decimales		
					if (n==-1)
					{	
						cantidad_actual = cantidad_actual+".";					
					}
				
				}
				else if (num == '-')
				{
				
							if (cantidad_actual.charAt(0) == "-")
								cantidad_actual = cantidad_actual.substr(1, cantidad_actual.length -1) ;
							else 
								cantidad_actual = "-" + cantidad_actual;
				}
				else
				{				
					if (cantidad_actual != "0" )
					{
						
						cantidad_actual = cantidad_actual + num;
					}
					else
					{
					
						cantidad_actual = num;
					}
				}
                var texto_aux = "Total ahora: " + cantidad_actual +  " &#8364;";
								
				document.getElementById("Amount_label").innerHTML = texto_aux;
			}
			
			function reset() 
			{
				cantidad_actual="0";
				document.getElementById("Amount_label").innerHTML = "Total ahora: " + cantidad_actual +  " &#8364;";
			}
			
			function suprimir() {
				if (cantidad_actual.length==1) {
					cantidad_actual='0';
				}
				else {
					//metodo substr devuelve un substring del string, y le pasamos posición y longitud.
					cantidad_actual=cantidad_actual.substr(0, cantidad_actual.length -1);
				}
				document.getElementById("Amount_label").innerHTML = "Total ahora: " + cantidad_actual +  " &#8364;";
			}
			
			function add() 
			{
				// vamos a introducir una nueva cantidad cuando pulsemos al botón añadir		
				var aux ;
				
				cantidad_total =  parseFloat(cantidad_actual) + parseFloat(cantidad_total) ;			
				document.getElementById("Total_Amount_label").innerHTML = "Total acumulado: " + cantidad_total  + " &#8364;";
				actualizar_pagina_ppal();
				registrar_ticket(cantidad_actual, path_actual);
				
				cantidad_actual = 0;
				document.getElementById("Amount_label").innerHTML ="Total ahora: " + cantidad_actual  + " &#8364;";
			}

			
			function actualizar_pagina_ppal()
			{
				document.getElementById("Mostrar_Cantidad").innerHTML =
				"Gastos: " + cantidad_total + " &#8364;";
			}

			function registrar_ticket(cantidad, path)
				{
				var ticket = [];
				ticket ["cantidad"] = cantidad;
				ticket ["path"] = path;

				//alert( ticket["cantidad"] );
				lista_tickets.push(ticket);

				document.getElementById("Numero_tickets").innerHTML ="Tickets: " + lista_tickets.length;
			}
			
			//Método para vaciar el array de tickets
			function vaciar_lista_tickets()
			{
				lista_tickets=[];
				//lista_tickets.length = 0
				document.getElementById("Numero_tickets").innerHTML ="Tickets: " + lista_tickets.length;
			}
			
			function mostrar_lista_tickets()
			{
				alert("Lista de tickets hata ahora");	
										
			}
			
			function nuevosgastos () {
				//-- Nueva cuenta, vaciamos todos los datos o ponemos a 0 las variables para volver a empezar --//
				cantidad_total = "0";
				
				document.getElementById("Total_Amount_label").innerHTML = "Total acumulado: " + cantidad_total  + " &#8364;";
				actualizar_pagina_ppal();
				vaciar_lista_tickets();
				cantidad_actual = 0;
				document.getElementById("Amount_label").innerHTML ="Total ahora: " + cantidad_actual  + " &#8364;";
			}
		
		</script>


</body>
</html>
